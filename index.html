<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Division - Custom Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #333;
            overflow-y: auto;
            padding: 20px;
        }

        .container {
            width: 1080px;
            height: 1920px;
            display: flex;
            flex-direction: column;
            background: #000;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid white;
            position: relative;
            flex: 1 1 0;
            min-height: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .history-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: none;
            align-items: flex-start;
            flex-direction: column;
            z-index: 20;
        }

        .edit-btn, .export-btn {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            background: white;
            color: #1e3a8a;
            border: 2px solid white;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
            transition: all 0.3s;
        }

        .edit-btn:hover, .export-btn:hover {
            background: #1e3a8a;
            color: white;
        }

        .division-select {
            padding: 10px 12px;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid white;
            border-radius: 5px;
            background: white;
            color: #1e3a8a;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
        }

        .custom-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1e1e1e;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 25px;
            z-index: 1000;
            min-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .custom-panel.visible {
            display: block;
        }

        .custom-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 999;
        }

        .custom-overlay.visible {
            display: block;
        }

        .custom-panel h3 {
            color: white;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .custom-title-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .custom-title-row input {
            flex: 1;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #2a2a2a;
            color: white;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
        }

        .division-row {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .division-group {
            display: flex;
            gap: 8px;
        }

        .division-toggle {
            flex: 1;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: bold;
            border: 2px solid #3b82f6;
            border-radius: 5px;
            background: #2a2a2a;
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
        }

        .division-toggle:hover {
            background: #3b82f6;
            color: white;
        }

        .division-toggle.active {
            background: #3b82f6;
            color: white;
        }

        .custom-team-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            cursor: grab;
            user-select: none;
        }

        .custom-team-row:active {
            cursor: grabbing;
        }

        .custom-team-row.dragging {
            opacity: 0.4;
        }

        .custom-team-row.drag-over {
            border-top: 3px solid #3b82f6;
        }

        .custom-team-row .drag-handle {
            color: #888;
            font-size: 18px;
            cursor: grab;
            padding: 0 5px;
        }

        .custom-team-row .team-name {
            color: white;
            font-weight: bold;
            width: 130px;
            font-size: 14px;
        }

        .custom-team-row input {
            flex: 1;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #2a2a2a;
            color: white;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
        }

        .custom-sort-row {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .custom-sort-row button {
            flex: 1;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: bold;
            border: 2px solid #3b82f6;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
            background: #2a2a2a;
            color: #3b82f6;
            transition: all 0.2s;
        }

        .custom-sort-row button:hover {
            background: #3b82f6;
            color: white;
        }

        .custom-apply-btn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .custom-apply-btn:hover {
            background: #2563eb;
        }

        .history-toggle-btn {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.35);
            color: white;
            cursor: pointer;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
            backdrop-filter: blur(4px);
        }

        .history-popover {
            display: none;
            margin-top: 8px;
            width: 330px;
            max-height: 380px;
            overflow-y: auto;
            background: rgba(10, 17, 33, 0.94);
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 10px;
            padding: 8px;
            box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
        }

        .history-popover.visible {
            display: block;
        }

        .history-item {
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(30, 41, 59, 0.6);
            padding: 8px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .history-item.auto {
            border-left: 4px solid #38bdf8;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-item-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .history-item-logos {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-conf-logo {
            height: 16px;
            width: auto;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 2px;
        }

        .history-station-logo {
            height: 16px;
            width: auto;
            max-width: 90px;
            object-fit: contain;
        }

        .history-division-badge {
            font-size: 10px;
            font-weight: bold;
            color: #bfdbfe;
            letter-spacing: 0.5px;
        }

        .history-delete-btn {
            border: none;
            background: transparent;
            color: #cbd5e1;
            font-size: 14px;
            cursor: pointer;
            padding: 0 4px;
        }

        .history-item-title {
            font-size: 12px;
            color: #f8fafc;
            font-weight: bold;
            line-height: 1.1;
        }

        .history-item-subtitle {
            font-size: 11px;
            color: #cbd5e1;
            margin-top: 2px;
            line-height: 1.15;
        }

        .history-item-date {
            margin-top: 5px;
            font-size: 10px;
            color: #94a3b8;
        }

        .custom-logo-section {
            margin-bottom: 15px;
        }

        .custom-logo-section > label {
            color: #ccc;
            font-size: 13px;
            display: block;
            margin-bottom: 8px;
        }

        .logo-group {
            margin-bottom: 8px;
        }

        .logo-group-label {
            color: #999;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .logo-group-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .logo-toggle {
            padding: 5px 10px;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid #555;
            border-radius: 5px;
            background: #2a2a2a;
            color: #aaa;
            cursor: pointer;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
            transition: all 0.2s;
        }

        .logo-toggle:hover {
            border-color: #3b82f6;
            color: white;
        }

        .logo-toggle.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        .custom-logo-url {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #2a2a2a;
            color: white;
            font-family: 'Arial Black', 'Arial Bold', sans-serif;
            margin-top: 8px;
            display: none;
        }

        .custom-logo-url.visible {
            display: block;
        }

        .logo-container {
            margin-bottom: 15px;
        }

        .header.dark-logo-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #dbeafe 100%) !important;
        }

        .header.dark-logo-bg .title,
        .header.dark-logo-bg .subtitle {
            color: #0f172a;
            text-shadow: none;
        }

        .logo-container img {
            height: 140px;
            width: auto;
        }

        .logo-container img.logo-white-invert {
            filter: brightness(0) invert(1);
        }

        .logo-container img.logo-black-invert {
            filter: brightness(0);
        }

        .title {
            color: white;
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            color: white;
            font-size: 27px;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .teams-container {
            flex: 4;
            display: flex;
            flex-direction: column;
        }

        .team-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            border-top: 3px solid white;
            border-bottom: 3px solid white;
            position: relative;
            flex: 1 1 0;
            min-height: 0;
        }

        .team-row:not(:last-child) {
            border-bottom: none;
        }

        .team-logo {
            height: 110%;
            width: 40%;
            object-fit: contain;
        }

        .points {
            color: white;
            font-size: 120px;
            font-weight: 900;
            letter-spacing: 5px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            font-family: 'Impact', 'Arial Black', sans-serif;
            display: flex;
            align-items: center;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .title {
                font-size: 32px;
            }
            .subtitle {
                font-size: 14px;
            }
            .points {
                font-size: 80px;
            }
            .team-logo {
                height: 110%;
                width: 40%;
            }
        }
    </style>
</head>
<body>
    <div class="custom-overlay" id="custom-overlay"></div>
    <div class="custom-panel" id="custom-panel">
        <h3>Custom Values</h3>
        <div class="custom-title-row">
            <input type="text" id="custom-title" placeholder="Title (e.g. Rushing Yards)">
            <input type="text" id="custom-subtitle" placeholder="Subtitle (e.g. In the NFC East)">
        </div>
        <div class="division-row">
            <div class="division-group" id="conference-buttons">
                <button class="division-toggle conference-toggle" data-value="NFC">NFC</button>
                <button class="division-toggle conference-toggle" data-value="AFC">AFC</button>
            </div>
            <div class="division-group" id="division-buttons">
                <button class="division-toggle division-toggle-btn" data-value="EAST">EAST</button>
                <button class="division-toggle division-toggle-btn" data-value="NORTH">NORTH</button>
                <button class="division-toggle division-toggle-btn" data-value="SOUTH">SOUTH</button>
                <button class="division-toggle division-toggle-btn" data-value="WEST">WEST</button>
            </div>
        </div>
        <div class="custom-logo-section">
            <label>Header Logo</label>
            <div id="division-station-options"></div>
            <div class="logo-group">
                <div class="logo-group-label">Custom</div>
                <div class="logo-group-buttons">
                    <button class="logo-toggle" data-url="custom" data-color="#1e3a8a,#3b82f6">URL...</button>
                </div>
                <input type="text" id="custom-logo-url" class="custom-logo-url" placeholder="Enter SVG URL...">
            </div>
        </div>
        <div id="custom-team-inputs"></div>
        <div class="custom-sort-row">
            <button id="sort-asc-btn">Sort Ascending</button>
            <button id="sort-desc-btn">Sort Descending</button>
        </div>
        <button class="custom-apply-btn" id="custom-apply-btn">Apply</button>
    </div>
    <div class="container">
    <div class="header">
        <div class="history-controls" id="history-controls">
            <button id="history-toggle-btn" class="history-toggle-btn">Snapshots</button>
            <div id="history-popover" class="history-popover"></div>
        </div>
        <div class="controls">
            <button id="edit-btn" class="edit-btn">Edit</button>
            <button id="export-btn" class="export-btn">Export PNG</button>
        </div>
        <div class="logo-container">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/WPVI-TV_logos.svg" alt="Network Logo" id="network-logo" crossorigin="anonymous">
        </div>
        <div class="title" id="page-title">Custom</div>
        <div class="subtitle" id="page-subtitle"></div>
    </div>

    <div class="teams-container" id="teams-container">
        <!-- Teams will be inserted here by JavaScript -->
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <script>
        const TV_STATIONS_BY_DIVISION = {
            nfc_east: [
                { label: '6ABC', url: 'https://upload.wikimedia.org/wikipedia/commons/9/9f/WPVI-TV_logos.svg', color: '#1e3a8a,#3b82f6' },
                { label: 'FOX 29', url: 'https://upload.wikimedia.org/wikipedia/commons/0/05/Fts-philadelphia-a.svg', color: '#003a70,#0064b0' },
                { label: 'NBC 4', url: 'https://upload.wikimedia.org/wikipedia/commons/1/1e/WRC-TV_2023.svg', color: '#b0c4de,#f0f4f8' },
                { label: 'ABC 7', url: 'https://upload.wikimedia.org/wikipedia/commons/a/a3/WABC_TV_New_2021.svg', color: '#0d47a1,#1976d2' }
            ],
            nfc_north: [
                { label: 'FOX 32 Chicago', url: 'https://upload.wikimedia.org/wikipedia/commons/1/18/Fts-chicago-a.svg', color: '#04134b,#04134b' },
                { label: 'FOX 2 Detroit', url: 'https://upload.wikimedia.org/wikipedia/commons/0/0c/Fts-detroit-a.svg', color: '#04134b,#04134b' },
                { label: 'FOX 9 Minneapolis', url: 'https://upload.wikimedia.org/wikipedia/commons/2/27/Fts-minneapolis-a.svg', color: '#04134b,#04134b' },
                { label: 'FOX 11 Green Bay', url: 'https://upload.wikimedia.org/wikipedia/commons/5/58/WLUK_Fox_11_solid_legal.svg', color: '#04134b,#04134b' }
            ],
            nfc_south: [
                { label: 'FOX 5 Atlanta', url: 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Fts-atlanta-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 35 Orlando', url: 'https://upload.wikimedia.org/wikipedia/commons/0/08/Fts-orlando-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 8 New Orleans', url: 'https://upload.wikimedia.org/wikipedia/commons/0/02/Wvue-logo.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 13 Tampa Bay', url: 'https://upload.wikimedia.org/wikipedia/commons/6/67/Fts-tampa-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 46 Charlotte', url: 'https://upload.wikimedia.org/wikipedia/commons/5/5a/Fts-charlotte-a.svg', color: '#003a70,#0064b0' }
            ],
            nfc_west: [
                { label: 'FOX 10 Arizona', url: 'https://upload.wikimedia.org/wikipedia/commons/9/9b/Fts-phoenix-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 11 Los Angeles', url: 'https://upload.wikimedia.org/wikipedia/commons/0/0a/Fts-los-angeles-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 2 San Francisco', url: 'https://upload.wikimedia.org/wikipedia/commons/8/89/Fts-san-francisco-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 13 Seattle', url: 'https://upload.wikimedia.org/wikipedia/commons/6/6d/Fts-seattle-a.svg', color: '#003a70,#0064b0' }
            ],
            afc_east: [
                { label: 'WCVB ABC 5 (NE)', url: 'https://upload.wikimedia.org/wikipedia/commons/9/9b/WCVB-TV_alternate_2021.svg', color: '#b71c1c,#e53935' },
                { label: 'FOX Buffalo', url: 'https://upload.wikimedia.org/wikipedia/commons/3/35/Fts-buffalo-a.svg', color: '#003a70,#0064b0' },
                { label: 'WSVN 7 Miami', url: 'https://upload.wikimedia.org/wikipedia/commons/9/95/Wsvn-miami.svg', color: '#1e293b,#475569' },
                { label: 'ABC 7 NY', url: 'https://upload.wikimedia.org/wikipedia/commons/a/a3/WABC_TV_New_2021.svg', color: '#0d47a1,#1976d2' }
            ],
            afc_north: [
                { label: 'FOX 43 PIT', url: 'https://upload.wikimedia.org/wikipedia/commons/4/4d/Fts-pittsburgh-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 19 CIN', url: 'https://upload.wikimedia.org/wikipedia/commons/b/b8/Fts-cincinnati-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 8 CLE', url: 'https://upload.wikimedia.org/wikipedia/commons/0/01/Fts-cleveland-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 45 BAL', url: 'https://upload.wikimedia.org/wikipedia/commons/5/59/Fts-baltimore-a.svg', color: '#003a70,#0064b0' }
            ],
            afc_south: [
                { label: 'FOX 26 Houston', url: 'https://upload.wikimedia.org/wikipedia/commons/8/80/Fts-houston-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 59 Indianapolis', url: 'https://upload.wikimedia.org/wikipedia/commons/6/61/Fts-indianapolis-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 30 Jacksonville', url: 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Fts-jacksonville-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 17 Tennessee', url: 'https://upload.wikimedia.org/wikipedia/commons/3/3d/Fts-nashville-a.svg', color: '#003a70,#0064b0' }
            ],
            afc_west: [
                { label: 'FOX 31 Denver', url: 'https://upload.wikimedia.org/wikipedia/commons/e/e6/Fts-denver-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 4 Kansas City', url: 'https://upload.wikimedia.org/wikipedia/commons/d/dd/Fts-kansas-city-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 5 Nevada', url: 'https://upload.wikimedia.org/wikipedia/commons/1/18/Fts-las-vegas-a.svg', color: '#003a70,#0064b0' },
                { label: 'FOX 11 LA Chargers', url: 'https://upload.wikimedia.org/wikipedia/commons/0/0a/Fts-los-angeles-a.svg', color: '#003a70,#0064b0' }
            ]
        };

        let teamsData = [];
        let allTeamData = {};
        let divisionDataCache = {};
        let divisionStationOverrides = {};
        let selectedConference = 'NFC';
        let selectedDivision = 'EAST';
        const SETTINGS_STORAGE_KEY = 'nflDivisionDashboard.settings.v1';
        const HISTORY_STORAGE_KEY = 'nflDivisionDashboard.history.v1';
        const HISTORY_LIMIT = 20;

        // Custom panel state
        let customOrder = []; // team names in drag order
        let customValues = {}; // team -> value
        let customDragSrc = null;
        let divisionStates = {};
        let settingsHistory = [];
        let autoSnapshotTimer = null;
        let logoAnalysisRequestId = 0;
        const CONFERENCE_LOGO_BY_KEY = {
            AFC: 'https://upload.wikimedia.org/wikipedia/commons/7/7a/American_Football_Conference_logo.svg',
            NFC: 'https://upload.wikimedia.org/wikipedia/commons/6/6f/National_Football_Conference_logo.svg'
        };

        let selectedLogoUrl = 'https://upload.wikimedia.org/wikipedia/commons/9/9f/WPVI-TV_logos.svg';
        let selectedHeaderColors = ['#1e3a8a', '#3b82f6'];

        function getDivisionKey() {
            return `${selectedConference.toLowerCase()}_${selectedDivision.toLowerCase()}`;
        }

        function getDivisionLabel() {
            return `${selectedConference} ${selectedDivision}`;
        }

        function renderDivisionButtons() {
            document.querySelectorAll('.conference-toggle').forEach((button) => {
                button.classList.toggle('active', button.dataset.value === selectedConference);
            });
            document.querySelectorAll('.division-toggle-btn').forEach((button) => {
                button.classList.toggle('active', button.dataset.value === selectedDivision);
            });
        }

        function getDefaultStationsForDivision() {
            const divisionStations = getStationsForDivision();
            return divisionStations[0] || {
                url: 'https://upload.wikimedia.org/wikipedia/commons/9/9f/WPVI-TV_logos.svg',
                color: '#1e3a8a,#3b82f6'
            };
        }

        function getStationsForDivision() {
            const key = getDivisionKey();
            return divisionStationOverrides[key] || TV_STATIONS_BY_DIVISION[key] || [];
        }

        function normalizeColorPair(colorCsv) {
            const parts = (colorCsv || '').split(',');
            return [
                parts[0] ? parts[0].trim() : '#1e3a8a',
                parts[1] ? parts[1].trim() : '#3b82f6'
            ];
        }

        function getSelectedLogoUrl() {
            const active = document.querySelector('.logo-toggle.active');
            if (active && active.dataset.url === 'custom') {
                return document.getElementById('custom-logo-url').value || selectedLogoUrl;
            }
            return selectedLogoUrl;
        }

        function setLogoBackgroundMode(enable) {
            const header = document.querySelector('.header');
            header.classList.toggle('dark-logo-bg', !!enable);
        }

        function shouldForceWhiteFoxLogo() {
            const active = document.querySelector('.logo-toggle.active');
            if (!active) return false;
            return getDivisionKey() === 'nfc_north' && active.textContent.trim().startsWith('FOX');
        }

        function hexToRgb(hex) {
            const clean = (hex || '').replace('#', '').trim();
            const full = clean.length === 3
                ? clean.split('').map((ch) => ch + ch).join('')
                : clean;
            if (!/^[0-9a-fA-F]{6}$/.test(full)) return null;
            return {
                r: parseInt(full.slice(0, 2), 16),
                g: parseInt(full.slice(2, 4), 16),
                b: parseInt(full.slice(4, 6), 16)
            };
        }

        function colorDistance(a, b) {
            const dr = a.r - b.r;
            const dg = a.g - b.g;
            const db = a.b - b.b;
            return Math.sqrt((dr * dr) + (dg * dg) + (db * db));
        }

        function luminance(rgb) {
            return (0.2126 * rgb.r) + (0.7152 * rgb.g) + (0.0722 * rgb.b);
        }

        function analyzeLogoProfile(url, bgHex) {
            return new Promise((resolve) => {
                if (!url) {
                    resolve({ needsLightHeader: false, needsInvert: false, invertToWhite: true });
                    return;
                }
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = 40;
                        canvas.height = 40;
                        const ctx = canvas.getContext('2d', { willReadFrequently: true });
                        ctx.clearRect(0, 0, 40, 40);
                        ctx.drawImage(img, 0, 0, 40, 40);
                        const data = ctx.getImageData(0, 0, 40, 40).data;

                        let sampled = 0;
                        let darkCount = 0;
                        let alphaCount = 0;
                        let sumR = 0;
                        let sumG = 0;
                        let sumB = 0;

                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            const a = data[i + 3];
                            if (a < 20) continue;
                            alphaCount++;
                            const luminance = (0.2126 * r) + (0.7152 * g) + (0.0722 * b);
                            if (luminance < 48) darkCount++;
                            sumR += r;
                            sumG += g;
                            sumB += b;
                            sampled++;
                        }

                        if (!sampled || alphaCount < 40) {
                            resolve({ needsLightHeader: false, needsInvert: false, invertToWhite: true });
                            return;
                        }

                        const darkRatio = darkCount / sampled;
                        const avg = {
                            r: Math.round(sumR / sampled),
                            g: Math.round(sumG / sampled),
                            b: Math.round(sumB / sampled)
                        };
                        const bg = hexToRgb(bgHex) || { r: 30, g: 58, b: 138 };
                        const similarToBg = colorDistance(avg, bg) < 62;
                        const invertToWhite = luminance(bg) < 150;
                        resolve({
                            needsLightHeader: darkRatio > 0.65,
                            needsInvert: similarToBg,
                            invertToWhite
                        });
                    } catch (error) {
                        resolve({ needsLightHeader: false, needsInvert: false, invertToWhite: true });
                    }
                };
                img.onerror = () => resolve({ needsLightHeader: false, needsInvert: false, invertToWhite: true });
                img.src = `${url}${url.includes('?') ? '&' : '?'}cb=${Date.now()}`;
            });
        }

        function refreshLogoContrastBackground(url, bgHex) {
            const requestId = ++logoAnalysisRequestId;
            const networkLogo = document.getElementById('network-logo');
            const forceWhiteFoxLogo = shouldForceWhiteFoxLogo();
            networkLogo.classList.toggle('logo-white-invert', forceWhiteFoxLogo);
            networkLogo.classList.remove('logo-black-invert');

            if (forceWhiteFoxLogo) {
                setLogoBackgroundMode(false);
                return;
            }

            setLogoBackgroundMode(false);
            analyzeLogoProfile(url, bgHex).then((profile) => {
                if (requestId !== logoAnalysisRequestId) return;
                if (profile.needsInvert) {
                    networkLogo.classList.toggle('logo-white-invert', profile.invertToWhite);
                    networkLogo.classList.toggle('logo-black-invert', !profile.invertToWhite);
                    setLogoBackgroundMode(false);
                    return;
                }
                networkLogo.classList.remove('logo-white-invert');
                networkLogo.classList.remove('logo-black-invert');
                setLogoBackgroundMode(profile.needsLightHeader);
            });
        }

        function persistCurrentDivisionState() {
            const key = getDivisionKey();
            if (!teamsData.length) return;
            divisionStates[key] = {
                title: document.getElementById('custom-title').value,
                subtitle: document.getElementById('custom-subtitle').value,
                order: [...customOrder],
                values: { ...customValues },
                logoUrl: selectedLogoUrl,
                colors: [...selectedHeaderColors]
            };
        }

        function buildCurrentSettingsSnapshot() {
            return {
                selectedConference,
                selectedDivision,
                divisionStates: JSON.parse(JSON.stringify(divisionStates)),
                selectedLogoUrl,
                selectedHeaderColors: [...selectedHeaderColors],
                customLogoInput: document.getElementById('custom-logo-url').value || ''
            };
        }

        function saveSettingsToStorage() {
            try {
                localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(buildCurrentSettingsSnapshot()));
                scheduleAutoSnapshot();
            } catch (error) {
                console.warn('Unable to save settings:', error);
            }
        }

        function restoreSettingsFromStorage() {
            try {
                const raw = localStorage.getItem(SETTINGS_STORAGE_KEY);
                if (!raw) return;
                const saved = JSON.parse(raw);
                selectedConference = saved.selectedConference || selectedConference;
                selectedDivision = saved.selectedDivision || selectedDivision;
                divisionStates = saved.divisionStates || {};
                selectedLogoUrl = saved.selectedLogoUrl || selectedLogoUrl;
                selectedHeaderColors = Array.isArray(saved.selectedHeaderColors) && saved.selectedHeaderColors.length === 2
                    ? saved.selectedHeaderColors
                    : selectedHeaderColors;
                document.getElementById('custom-logo-url').value = saved.customLogoInput || '';
            } catch (error) {
                console.warn('Unable to restore settings:', error);
            }
        }

        function saveHistoryToStorage() {
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(settingsHistory));
            } catch (error) {
                console.warn('Unable to save history:', error);
            }
        }

        function restoreHistoryFromStorage() {
            try {
                const raw = localStorage.getItem(HISTORY_STORAGE_KEY);
                settingsHistory = raw ? JSON.parse(raw) : [];
            } catch (error) {
                settingsHistory = [];
            }
        }

        function formatShortDateTime(timestamp) {
            const d = new Date(timestamp);
            return d.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
        }

        function renderHistoryPopover() {
            const controls = document.getElementById('history-controls');
            const popover = document.getElementById('history-popover');
            const toggle = document.getElementById('history-toggle-btn');

            controls.style.display = settingsHistory.length ? 'flex' : 'none';
            toggle.textContent = settingsHistory.length ? `Snapshots ${settingsHistory.length}` : 'Snapshots';
            popover.innerHTML = '';

            settingsHistory.forEach((item) => {
                const confKey = item.conference || item.state?.selectedConference || '';
                const divKey = item.division || item.state?.selectedDivision || '';
                const stationUrl = item.stationLogoUrl || item.state?.selectedLogoUrl || '';
                const row = document.createElement('div');
                row.className = `history-item${item.auto ? ' auto' : ''}`;
                row.dataset.id = item.id;

                const top = document.createElement('div');
                top.className = 'history-item-top';

                const logos = document.createElement('div');
                logos.className = 'history-item-logos';

                if (CONFERENCE_LOGO_BY_KEY[confKey]) {
                    const conf = document.createElement('img');
                    conf.className = 'history-conf-logo';
                    conf.alt = confKey || 'Conference';
                    conf.src = CONFERENCE_LOGO_BY_KEY[confKey];
                    logos.appendChild(conf);
                }

                if (stationUrl) {
                    const station = document.createElement('img');
                    station.className = 'history-station-logo';
                    station.alt = item.stationLabel || 'Station';
                    station.src = stationUrl;
                    logos.appendChild(station);
                }

                const badge = document.createElement('span');
                badge.className = 'history-division-badge';
                badge.textContent = `${confKey} ${divKey}`.trim();
                logos.appendChild(badge);

                const del = document.createElement('button');
                del.className = 'history-delete-btn';
                del.type = 'button';
                del.textContent = '\u00d7';
                del.addEventListener('click', (event) => {
                    event.stopPropagation();
                    deleteSnapshotById(item.id);
                });

                top.appendChild(logos);
                top.appendChild(del);
                row.appendChild(top);

                const title = document.createElement('div');
                title.className = 'history-item-title';
                title.textContent = item.title || 'Custom';
                row.appendChild(title);

                const subtitle = document.createElement('div');
                subtitle.className = 'history-item-subtitle';
                subtitle.textContent = item.subtitle || `In the ${confKey} ${divKey}`.trim();
                row.appendChild(subtitle);

                const date = document.createElement('div');
                date.className = 'history-item-date';
                date.textContent = formatShortDateTime(item.createdAt || Number(item.id));
                row.appendChild(date);

                row.addEventListener('click', () => {
                    loadSnapshotById(item.id);
                    document.getElementById('history-popover').classList.remove('visible');
                });

                popover.appendChild(row);
            });
        }

        function saveSnapshot(auto = false) {
            persistCurrentDivisionState();
            const snapshotState = buildCurrentSettingsSnapshot();
            const stateKey = JSON.stringify(snapshotState);
            if (settingsHistory[0] && settingsHistory[0].stateKey === stateKey) {
                return;
            }
            const now = new Date();
            const activeLogo = document.querySelector('.logo-toggle.active');
            const snapshot = {
                id: String(now.getTime()),
                createdAt: now.toISOString(),
                conference: selectedConference,
                division: selectedDivision,
                stationLabel: activeLogo ? activeLogo.textContent.trim() : '',
                stationLogoUrl: getSelectedLogoUrl(),
                title: document.getElementById('custom-title').value || 'Custom',
                subtitle: document.getElementById('custom-subtitle').value || `In the ${getDivisionLabel()}`,
                auto: !!auto,
                state: snapshotState,
                stateKey
            };
            settingsHistory.unshift(snapshot);
            settingsHistory = settingsHistory.slice(0, HISTORY_LIMIT);
            saveHistoryToStorage();
            renderHistoryPopover();
        }

        function scheduleAutoSnapshot() {
            clearTimeout(autoSnapshotTimer);
            autoSnapshotTimer = setTimeout(() => saveSnapshot(true), 1200);
        }

        function loadSnapshotById(snapshotId) {
            const snapshot = settingsHistory.find(item => item.id === snapshotId);
            if (!snapshot) return;

            const state = snapshot.state || {};
            selectedConference = state.selectedConference || selectedConference;
            selectedDivision = state.selectedDivision || selectedDivision;
            divisionStates = state.divisionStates || {};
            selectedLogoUrl = state.selectedLogoUrl || selectedLogoUrl;
            selectedHeaderColors = Array.isArray(state.selectedHeaderColors) && state.selectedHeaderColors.length === 2
                ? state.selectedHeaderColors
                : selectedHeaderColors;
            document.getElementById('custom-logo-url').value = state.customLogoInput || '';
            renderDivisionButtons();

            loadDivisionData().then(() => {
                saveSettingsToStorage();
            });
        }

        function deleteSnapshotById(snapshotId) {
            settingsHistory = settingsHistory.filter(item => item.id !== snapshotId);
            saveHistoryToStorage();
            renderHistoryPopover();
        }

        function applyStateForDivision() {
            const key = getDivisionKey();
            const saved = divisionStates[key];
            const defaultStation = getDefaultStationsForDivision();

            customOrder = teamsData.map(t => t.team);
            customValues = {};
            selectedLogoUrl = defaultStation.url;
            selectedHeaderColors = normalizeColorPair(defaultStation.color);
            document.getElementById('custom-title').value = '';
            document.getElementById('custom-subtitle').value = `In the ${getDivisionLabel()}`;

            if (saved) {
                document.getElementById('custom-title').value = saved.title || '';
                document.getElementById('custom-subtitle').value = saved.subtitle || `In the ${getDivisionLabel()}`;
                customOrder = saved.order && saved.order.length ? [...saved.order] : customOrder;
                customValues = saved.values ? { ...saved.values } : {};
                selectedLogoUrl = saved.logoUrl || selectedLogoUrl;
                selectedHeaderColors = saved.colors && saved.colors.length === 2
                    ? [...saved.colors]
                    : selectedHeaderColors;
            }
        }

        function renderStationOptions() {
            const parent = document.getElementById('division-station-options');
            parent.innerHTML = '';

            const group = document.createElement('div');
            group.className = 'logo-group';

            const label = document.createElement('div');
            label.className = 'logo-group-label';
            label.textContent = `${getDivisionLabel()} Top Stations`;
            group.appendChild(label);

            const buttons = document.createElement('div');
            buttons.className = 'logo-group-buttons';
            getStationsForDivision().forEach((station) => {
                const btn = document.createElement('button');
                btn.className = 'logo-toggle';
                btn.dataset.url = station.url;
                btn.dataset.color = station.color;
                btn.textContent = station.label;
                if (station.url === selectedLogoUrl) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', handleLogoToggleClick);
                buttons.appendChild(btn);
            });
            group.appendChild(buttons);
            parent.appendChild(group);

            const customBtn = document.querySelector('.logo-toggle[data-url="custom"]');
            if (customBtn) {
                const hasDivisionMatch = getStationsForDivision()
                    .some(station => station.url === selectedLogoUrl);
                customBtn.classList.toggle('active', !hasDivisionMatch);
                customBtn.removeEventListener('click', handleLogoToggleClick);
                customBtn.addEventListener('click', handleLogoToggleClick);
            }

            const urlInput = document.getElementById('custom-logo-url');
            if (customBtn && customBtn.classList.contains('active')) {
                urlInput.classList.add('visible');
            } else {
                urlInput.classList.remove('visible');
            }
        }

        function handleLogoToggleClick(e) {
            const btn = e.currentTarget;
            document.querySelectorAll('.logo-toggle').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const urlInput = document.getElementById('custom-logo-url');
            if (btn.dataset.url === 'custom') {
                urlInput.classList.add('visible');
                urlInput.focus();
            } else {
                urlInput.classList.remove('visible');
                selectedLogoUrl = btn.dataset.url;
            }
            selectedHeaderColors = normalizeColorPair(btn.dataset.color);
            saveSettingsToStorage();
        }

        function openCustomPanel() {
            const panel = document.getElementById('custom-panel');
            const overlay = document.getElementById('custom-overlay');
            panel.classList.add('visible');
            overlay.classList.add('visible');

            renderStationOptions();
            renderCustomInputs();
        }

        function closeCustomPanel() {
            document.getElementById('custom-panel').classList.remove('visible');
            document.getElementById('custom-overlay').classList.remove('visible');
        }

        function renderCustomInputs() {
            const container = document.getElementById('custom-team-inputs');
            container.innerHTML = '';

            customOrder.forEach((teamName, idx) => {
                const team = teamsData.find(t => t.team === teamName);
                if (!team) return;

                const row = document.createElement('div');
                row.className = 'custom-team-row';
                row.style.background = team.color;
                row.draggable = true;
                row.dataset.team = teamName;
                row.dataset.index = idx;

                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.textContent = '\u2630';

                const name = document.createElement('span');
                name.className = 'team-name';
                name.textContent = teamName;

                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Value';
                input.value = customValues[teamName] || '';
                input.addEventListener('input', (event) => {
                    customValues[teamName] = event.target.value;
                    persistCurrentDivisionState();
                    saveSettingsToStorage();
                });

                row.appendChild(handle);
                row.appendChild(name);
                row.appendChild(input);
                container.appendChild(row);

                row.addEventListener('dragstart', (event) => {
                    customDragSrc = idx;
                    row.classList.add('dragging');
                    event.dataTransfer.effectAllowed = 'move';
                });
                row.addEventListener('dragend', () => {
                    row.classList.remove('dragging');
                    container.querySelectorAll('.custom-team-row').forEach(r => r.classList.remove('drag-over'));
                });
                row.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    event.dataTransfer.dropEffect = 'move';
                    container.querySelectorAll('.custom-team-row').forEach(r => r.classList.remove('drag-over'));
                    row.classList.add('drag-over');
                });
                row.addEventListener('drop', (event) => {
                    event.preventDefault();
                    row.classList.remove('drag-over');
                    const targetIdx = parseInt(row.dataset.index, 10);
                    if (customDragSrc !== null && customDragSrc !== targetIdx) {
                        const item = customOrder.splice(customDragSrc, 1)[0];
                        customOrder.splice(targetIdx, 0, item);
                        renderCustomInputs();
                    }
                    customDragSrc = null;
                });
            });
        }

        function sortCustom(ascending) {
            customOrder.sort((a, b) => {
                const va = customValues[a] || '';
                const vb = customValues[b] || '';
                const na = parseFloat(va);
                const nb = parseFloat(vb);
                if (!isNaN(na) && !isNaN(nb)) {
                    return ascending ? na - nb : nb - na;
                }
                return ascending ? va.localeCompare(vb) : vb.localeCompare(va);
            });
            renderCustomInputs();
            persistCurrentDivisionState();
            saveSettingsToStorage();
        }

        function renderCustomTeams() {
            const title = document.getElementById('custom-title').value || 'Custom';
            const subtitle = document.getElementById('custom-subtitle').value || `In the ${getDivisionLabel()}`;
            const logoUrl = getSelectedLogoUrl();

            document.getElementById('page-title').textContent = title;
            document.getElementById('page-subtitle').textContent = subtitle;
            const networkLogo = document.getElementById('network-logo');
            networkLogo.src = logoUrl;
            networkLogo.alt = `${getDivisionLabel()} Network Logo`;
            refreshLogoContrastBackground(logoUrl, selectedHeaderColors[0]);
            document.querySelector('.header').style.background =
                `linear-gradient(135deg, ${selectedHeaderColors[0]} 0%, ${selectedHeaderColors[1]} 100%)`;

            const container = document.getElementById('teams-container');
            container.innerHTML = '';

            if (!teamsData.length) {
                container.innerHTML = '<div style="color: white; text-align: center; padding: 50px;">No team data found for this division</div>';
                return;
            }

            customOrder.forEach((teamName, index) => {
                const team = teamsData.find(t => t.team === teamName);
                if (!team) return;

                const row = document.createElement('div');
                row.className = 'team-row';
                row.style.backgroundColor = team.color;
                row.style.zIndex = customOrder.length - index;

                const logo = document.createElement('img');
                logo.crossOrigin = 'anonymous';
                logo.src = team.logo;
                logo.alt = `${team.team} Logo`;
                logo.className = 'team-logo';

                const points = document.createElement('div');
                points.className = 'points';
                const val = customValues[teamName] || '';
                if (val.length > 10) {
                    points.style.fontSize = '60px';
                } else if (val.length > 6) {
                    points.style.fontSize = '80px';
                }
                points.textContent = val;

                row.appendChild(logo);
                row.appendChild(points);
                container.appendChild(row);
            });
        }

        function applyCustom() {
            closeCustomPanel();
            persistCurrentDivisionState();
            renderCustomTeams();
            saveSettingsToStorage();
        }

        function fetchDivisionData(divisionKey) {
            if (divisionDataCache[divisionKey]) {
                return Promise.resolve(divisionDataCache[divisionKey]);
            }

            return fetch(`${divisionKey}.yml`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`Missing ${divisionKey}.yml`);
                    }
                    return response.text();
                })
                .then((yamlText) => {
                    const parsed = jsyaml.load(yamlText) || {};
                    const teams = parsed[divisionKey] || [];
                    const stations = parsed.station_logos || [];
                    divisionDataCache[divisionKey] = { teams, stations };
                    if (stations.length) {
                        divisionStationOverrides[divisionKey] = stations;
                    }
                    return divisionDataCache[divisionKey];
                })
                .catch(() => {
                    const fallback = allTeamData[divisionKey] || [];
                    divisionDataCache[divisionKey] = { teams: fallback, stations: [] };
                    return divisionDataCache[divisionKey];
                });
        }

        function loadDivisionData() {
            const divisionKey = getDivisionKey();
            return fetchDivisionData(divisionKey).then((data) => {
                teamsData = data.teams || [];
                renderDivisionButtons();
                applyStateForDivision();
                renderStationOptions();
                renderCustomInputs();
                renderCustomTeams();
            });
        }

        function exportToPNG() {
            const exportBtn = document.getElementById('export-btn');

            document.querySelector('.controls').style.display = 'none';
            exportBtn.textContent = 'Exporting...';
            exportBtn.disabled = true;

            const containerElement = document.querySelector('.container');

            setTimeout(() => {
                domtoimage.toPng(containerElement, {
                    width: 1080,
                    height: 1920,
                    quality: 1.0,
                    style: {
                        margin: '0',
                        padding: '0'
                    }
                }).then(function(dataUrl) {
                    const link = document.createElement('a');
                    const now = new Date();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const year = String(now.getFullYear()).slice(-2);
                    const filename = `${selectedConference}${selectedDivision}Meme-${month}-${day}-${year}.png`;

                    link.download = filename;
                    link.href = dataUrl;
                    link.click();

                    document.querySelector('.controls').style.display = 'flex';
                    exportBtn.textContent = 'Export PNG';
                    exportBtn.disabled = false;
                }).catch(function(error) {
                    console.error('Export error:', error);
                    document.querySelector('.controls').style.display = 'flex';
                    exportBtn.textContent = 'Export PNG';
                    exportBtn.disabled = false;
                    alert('Error exporting image. Please try again.');
                });
            }, 300);
        }

        fetch('nfceast.yml')
            .then(response => response.text())
            .then(yamlText => {
                allTeamData = jsyaml.load(yamlText) || {};
                restoreSettingsFromStorage();
                restoreHistoryFromStorage();
                renderHistoryPopover();
                renderDivisionButtons();

                document.querySelectorAll('.conference-toggle').forEach((button) => {
                    button.addEventListener('click', () => {
                        const value = button.dataset.value;
                        if (value === selectedConference) return;
                        persistCurrentDivisionState();
                        selectedConference = value;
                        loadDivisionData().then(() => saveSettingsToStorage());
                    });
                });

                document.querySelectorAll('.division-toggle-btn').forEach((button) => {
                    button.addEventListener('click', () => {
                        const value = button.dataset.value;
                        if (value === selectedDivision) return;
                        persistCurrentDivisionState();
                        selectedDivision = value;
                        loadDivisionData().then(() => saveSettingsToStorage());
                    });
                });

                document.getElementById('custom-logo-url').addEventListener('input', (event) => {
                    if (document.querySelector('.logo-toggle.active')?.dataset.url === 'custom') {
                        selectedLogoUrl = event.target.value.trim() || selectedLogoUrl;
                        persistCurrentDivisionState();
                        saveSettingsToStorage();
                    }
                });
                document.getElementById('custom-title').addEventListener('input', () => {
                    persistCurrentDivisionState();
                    saveSettingsToStorage();
                });
                document.getElementById('custom-subtitle').addEventListener('input', () => {
                    persistCurrentDivisionState();
                    saveSettingsToStorage();
                });
                document.getElementById('sort-asc-btn').addEventListener('click', () => sortCustom(true));
                document.getElementById('sort-desc-btn').addEventListener('click', () => sortCustom(false));
                document.getElementById('custom-apply-btn').addEventListener('click', applyCustom);
                document.getElementById('custom-overlay').addEventListener('click', closeCustomPanel);
                document.getElementById('edit-btn').addEventListener('click', openCustomPanel);
                document.getElementById('export-btn').addEventListener('click', exportToPNG);
                document.getElementById('history-toggle-btn').addEventListener('click', (event) => {
                    event.stopPropagation();
                    document.getElementById('history-popover').classList.toggle('visible');
                });
                document.getElementById('history-popover').addEventListener('click', (event) => {
                    event.stopPropagation();
                });
                document.addEventListener('click', () => {
                    document.getElementById('history-popover').classList.remove('visible');
                });

                loadDivisionData().then(() => saveSettingsToStorage());
            })
            .catch(error => {
                console.error('Error loading YAML:', error);
                document.getElementById('teams-container').innerHTML =
                    '<div style="color: white; text-align: center; padding: 50px;">Error loading data</div>';
            });
    </script>
</body>
</html>
